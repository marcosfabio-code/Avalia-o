import streamlit as st
import plotly.graph_objects as go
import pandas as pd

# ==============================================================================
# M√ìDULO 1: BASE DE CONHECIMENTO COMPORTAMENTAL (O "C√âREBRO" DO ESPECIALISTA)
# ==============================================================================
# Em um app real, isso viria de um banco de dados ou arquivo JSON separado.
# As letras representam: D=Domin√¢ncia (Executor), I=Influ√™ncia (Comunicador),
# S=Estabilidade (Planejador), C=Conformidade (Analista).

QUESTIONS_DB = [
    # Bloco 1: Foco e Motiva√ß√£o
    {"q": "Em um projeto novo, sua tend√™ncia natural √©:",
     "opts": {"D": "Assumir o comando e focar no resultado final r√°pido.",
              "I": "Engajar as pessoas e vender a ideia com entusiasmo.",
              "S": "Planejar os passos com calma para garantir seguran√ßa.",
              "C": "Analisar os dados e definir os processos com precis√£o."}},
    {"q": "O que mais te desmotiva no ambiente de trabalho?",
     "opts": {"D": "Falta de autonomia e lentid√£o nas decis√µes.",
              "I": "Trabalhar isolado e falta de reconhecimento p√∫blico.",
              "S": "Mudan√ßas bruscas constantes e ambientes hostis.",
              "C": "Falta de regras claras e trabalhos feitos sem qualidade."}},
    # Bloco 2: Resolu√ß√£o de Problemas e Press√£o
    {"q": "Sob forte press√£o e prazo curto, voc√™:",
     "opts": {"D": "Torna-se mais diretivo, impaciente e foca na a√ß√£o.",
              "I": "Tenta usar a persuas√£o e o otimismo para contornar a crise.",
              "S": "Tende a ceder para evitar conflito ou trava se n√£o houver roteiro.",
              "C": "Torna-se excessivamente cr√≠tico, r√≠gido e busca os detalhes."}},
    {"q": "Diante de um conflito na equipe, sua postura √©:",
     "opts": {"D": "Enfrentar diretamente para resolver logo.",
              "I": "Mediar conversando para manter o clima bom.",
              "S": "Ouvir todos os lados pacientemente para harmonizar.",
              "C": "Buscar os fatos e as regras para decidir quem est√° certo."}},
    # Bloco 3: Comunica√ß√£o e Estilo
    {"q": "Seu estilo de comunica√ß√£o predominante √©:",
     "opts": {"D": "Direto, objetivo e focado em tarefas.",
              "I": "Expressivo, entusiasta e focado em hist√≥rias.",
              "S": "Calmo, atencioso e focado em ouvir.",
              "C": "Preciso, formal e focado em dados/fatos."}},
    # (Para um teste real, seriam necess√°rias de 20 a 40 quest√µes para robustez estat√≠stica.
    # Usaremos 5 aqui apenas para demonstra√ß√£o funcional da arquitetura).
]

# Feedbacks de Alta Precis√£o para COMBINA√á√ïES de perfis.
# O especialista sabe que ningu√©m √© uma coisa s√≥.
FEEDBACK_MATRIX = {
    # Combina√ß√µes Puras (Raras, quando um perfil √© muito mais alto que os outros)
    "D_PURE": {
        "title": "O Comandante Natural (Alta Domin√¢ncia)",
        "luz": "Voc√™ √© movido por desafios. Sua capacidade de tomar decis√µes dif√≠ceis rapidamente e sua vis√£o focada em resultados s√£o seus maiores ativos. Voc√™ n√£o tem medo de assumir riscos.",
        "sombra": "Sob estresse, pode ser percebido como autorit√°rio, insens√≠vel ou atropelador. Tende a ignorar os sentimentos alheios na busca pela meta.",
        "acao": "Pratique a escuta ativa antes de decidir. Aprenda a delegar n√£o apenas a tarefa, mas tamb√©m a autoridade."
    },
    "I_PURE": {
        "title": "O Articulador Carism√°tico (Alta Influ√™ncia)",
        "luz": "Sua energia √© contagiante. Voc√™ tem um dom natural para conectar pessoas, vender ideias e manter o otimismo em alta, mesmo na adversidade.",
        "sombra": "Pode ter s√©rias dificuldades com foco, prazos e detalhes. Tende a prometer mais do que consegue entregar pela empolga√ß√£o do momento.",
        "acao": "Utilize ferramentas de organiza√ß√£o externa (checklists, agendas). Comprometa-se com menos coisas e foque na 'acabativa'."
    },
    "S_PURE": {
        "title": "O Pilar de Sustenta√ß√£o (Alta Estabilidade)",
        "luz": "Voc√™ traz equil√≠brio e consist√™ncia. Sua lealdade, paci√™ncia e capacidade de ouvir fazem de voc√™ um membro de equipe indispens√°vel e confi√°vel.",
        "sombra": "Sua avers√£o a mudan√ßas e conflitos pode te paralisar. Tem dificuldade em dizer 'n√£o' e pode acumular trabalho para n√£o desagradar.",
        "acao": "Treine a assertividade. Entenda que a mudan√ßa √© inevit√°vel e tente focar nos benef√≠cios que ela trar√° a longo prazo."
    },
    "C_PURE": {
        "title": "O Especialista Preciso (Alta Conformidade)",
        "luz": "A qualidade √© seu sobrenome. Voc√™ possui um pensamento anal√≠tico estruturado, aten√ß√£o aos detalhes e um respeito profundo por regras e m√©todos.",
        "sombra": "O perfeccionismo pode levar √† paralisia por an√°lise. Tende a ser excessivamente cr√≠tico consigo e com os outros, focando no erro e n√£o no acerto.",
        "acao": "Defina o que √© 'bom o suficiente' para n√£o perder prazos buscando a perfei√ß√£o inating√≠vel. Valorize o progresso, n√£o apenas o resultado perfeito."
    },

    # Combina√ß√µes Mistas (As mais comuns e ricas)
    "DI": { # Executor + Comunicador
        "title": "O Trator Carism√°tico (D+I)",
        "luz": "Combina√ß√£o potente de velocidade e persuas√£o. Voc√™ n√£o s√≥ quer o resultado r√°pido, como convence todos a correrem com voc√™.",
        "sombra": "Alt√≠ssimo risco de impulsividade e desorganiza√ß√£o. Detalhes e planejamentos longos s√£o sua kryptonita.",
        "acao": "Voc√™ precisa de um 'freio' externo. Associe-se a pessoas com perfil S ou C para cuidar da retaguarda enquanto voc√™ abre caminho."
    },
    "DC": { # Executor + Analista
        "title": "O Estrategista Exigente (D+C)",
        "luz": "Rara combina√ß√£o de √≠mpeto para a√ß√£o com rigor t√©cnico. Voc√™ quer resultados r√°pidos, mas que estejam absolutamente corretos.",
        "sombra": "Conflito interno constante entre 'fazer r√°pido' (D) e 'fazer perfeito' (C). Pode ser um l√≠der extremamente exigente e frio.",
        "acao": "Escolha suas batalhas. Nem toda tarefa exige perfei√ß√£o (C) e nem toda tarefa exige velocidade m√°xima (D). Contextualize."
    },
    "IS": { # Comunicador + Planejador
        "title": "O Diplomata Agregador (I+S)",
        "luz": "Excelente gestor de pessoas. Voc√™ tem o carisma para motivar (I) e a paci√™ncia para acolher e dar seguran√ßa (S).",
        "sombra": "Dificuldade extrema em tomar decis√µes impopulares ou demitir. Foge de conflitos a todo custo, o que pode gerar passividade.",
        "acao": "Entenda que o conflito produtivo √© necess√°rio para o crescimento. N√£o sacrifique o resultado apenas para manter a harmonia superficial."
    },
    # (Em um sistema completo, haveria DS, IC, SC e as varia√ß√µes de intensidade)
    "GENERIC_MIX": {
        "title": "Perfil Multifacetado",
        "luz": "Voc√™ possui uma distribui√ß√£o de energia equilibrada entre diferentes fatores, o que te d√° flexibilidade de adapta√ß√£o.",
        "sombra": "Pode sentir falta de uma dire√ß√£o clara ou mudar de postura dependendo do ambiente, gerando confus√£o nos outros.",
        "acao": "Identifique qual 'chap√©u' voc√™ precisa usar em cada situa√ß√£o. Use sua flexibilidade de forma estrat√©gica, n√£o reativa."
    }
}


# ==============================================================================
# M√ìDULO 2: FUN√á√ïES UTILIT√ÅRIAS E VISUALIZA√á√ÉO (O "BRA√áO" PYTHON)
# ==============================================================================

def calculate_profile(answers_map):
    """Calcula as porcentagens e define os perfis prim√°rios."""
    total = sum(answers_map.values())
    if total == 0: return None
    
    scores_pct = {k: (v / total * 100) for k, v in answers_map.items()}
    
    # Ordena os perfis do maior para o menor score
    sorted_profiles = sorted(scores_pct.items(), key=lambda item: item[1], reverse=True)
    primary = sorted_profiles[0]
    secondary = sorted_profiles[1]
    
    return scores_pct, primary, secondary

def plot_advanced_radar_chart(scores_pct, primary_profile_code):
    """
    Gera um gr√°fico de radar interativo profissional usando Plotly.
    O especialista sabe que a visualiza√ß√£o √© parte do diagn√≥stico.
    """
    # Mapeamento de cores baseado no perfil prim√°rio para identidade visual
    color_map = {"D": "#FF4136", "I": "#FFDC00", "S": "#2ECC40", "C": "#0074D9"}
    main_color = color_map.get(primary_profile_code, "grey")
    
    categories = ['Domin√¢ncia (D)', 'Influ√™ncia (I)', 'Estabilidade (S)', 'Conformidade (C)']
    # A ordem dos dados deve corresponder √† ordem das categorias acima
    values = [scores_pct.get('D',0), scores_pct.get('I',0), scores_pct.get('S',0), scores_pct.get('C',0)]

    fig = go.Figure()

    # Adiciona a √°rea preenchida (o "shape" do perfil)
    fig.add_trace(go.Scatterpolar(
        r=values,
        theta=categories,
        fill='toself',
        name='Seu Perfil',
        line_color=main_color,
        fillcolor=f"rgba({int(main_color[1:3], 16)}, {int(main_color[3:5], 16)}, {int(main_color[5:7], 16)}, 0.5)",
        marker=dict(size=8)
    ))

    # Configura√ß√£o fina do layout para parecer um instrumento profissional
    fig.update_layout(
        polar=dict(
            radialaxis=dict(
                visible=True,
                range=[0, 100], # Trava o eixo em 100%
                tickfont=dict(size=10, color="grey"),
                gridcolor="lightgrey",
                tickvals=[20, 40, 60, 80, 100]
            ),
            angularaxis=dict(
                tickfont=dict(size=14, weight="bold"),
                rotation=90, # Rotaciona para D ficar no topo
                direction="clockwise",
                gridcolor="lightgrey"
            )
        ),
        showlegend=False,
        height=500,
        margin=dict(l=50, r=50, t=50, b=50),
        paper_bgcolor="rgba(0,0,0,0)", # Fundo transparente
    )
    
    return fig

def get_expert_feedback(primary_code, secondary_code, primary_score, secondary_score):
    """L√≥gica do Especialista para selecionar o melhor feedback da matriz."""
    
    # L√≥gica para definir se √© um perfil "Puro" ou "Misto"
    # Se a diferen√ßa entre o 1¬∫ e o 2¬∫ for grande (>25%), consideramos "Puro"
    if (primary_score - secondary_score) > 25.0:
        key = f"{primary_code}_PURE"
    else:
        # Se s√£o pr√≥ximos, cria a chave combinada (ex: "DI", "IS")
        # Ordena alfabeticamente para garantir que DI seja igual a ID na chave
        code_list = sorted([primary_code, secondary_code])
        key = "".join(code_list)
        
    # Busca na matriz, se n√£o achar, usa o gen√©rico
    return FEEDBACK_MATRIX.get(key, FEEDBACK_MATRIX["GENERIC_MIX"])


# ==============================================================================
# M√ìDULO 3: A INTERFACE DO USU√ÅRIO (STREAMLIT)
# ==============================================================================

st.set_page_config(page_title="Assessment Comportamental Profissional", layout="wide", page_icon="üß†")

# Cabe√ßalho com toque profissional
col1, col2 = st.columns([1, 5])
with col1:
    st.image("https://cdn-icons-png.flaticon.com/512/2620/2620584.png", width=100) # √çcone gen√©rico de c√©rebro/an√°lise
with col2:
    st.title("Sistema de An√°lise Comportamental Avan√ßada")
    st.write("Metodologia baseada em tend√™ncias DISC | An√°lise de Especialista")

st.markdown("---")

# --- Sidebar para Contexto ---
with st.sidebar:
    st.header("Instru√ß√µes ao Avaliado")
    st.info("""
    Este n√£o √© um teste de certo ou errado. √â uma fotografia das suas tend√™ncias naturais.
    
    Para obter um resultado preciso:
    1. Responda com quem voc√™ **√©** hoje, n√£o quem gostaria de ser.
    2. N√£o pense muito. A primeira resposta costuma ser a mais real.
    3. Imagine-se no seu ambiente profissional.
    """)
    st.warning("Tempo estimado: 5 minutos")

# --- O Formul√°rio de Assessment ---
if 'submitted' not in st.session_state:
    st.session_state.submitted = False

if not st.session_state.submitted:
    st.subheader("Question√°rio de Mapeamento")
    
    with st.form("assessment_form"):
        user_responses = {}
        
        for i, q_data in enumerate(QUESTIONS_DB):
            st.markdown(f"##### {i+1}. {q_data['q']}")
            # Truque para salvar a chave (D,I,S,C) mas mostrar o texto
            options_display = [f"{k}::{v}" for k, v in q_data['opts'].items()]
            
            choice = st.radio(
                f"Op√ß√µes quest√£o {i}",
                options_display,
                label_visibility="collapsed",
                key=f"q{i}"
            )
            # Extrai s√≥ a letra (D,I,S,C) da resposta escolhida
            user_responses[f"q{i}"] = choice.split("::")[0]
            st.markdown("---")
            
        submit_btn = st.form_submit_button("üöÄ Processar Minha An√°lise Profissional", type="primary")
        
        if submit_btn:
            st.session_state.submitted = True
            st.session_state.responses = user_responses
            st.rerun()

# --- A Gera√ß√£o do Relat√≥rio (P√≥s-Submiss√£o) ---
else:
    with st.spinner("O especialista est√° analisando seus dados..."):
        # 1. Processamento dos Dados
        scores_raw = {"D": 0, "I": 0, "S": 0, "C": 0}
        for resp in st.session_state.responses.values():
            scores_raw[resp] += 1
            
        scores_pct, primary_tup, secondary_tup = calculate_profile(scores_raw)
        
        # 2. Busca do Feedback Inteligente
        feedback_data = get_expert_feedback(
            primary_tup[0], secondary_tup[0], primary_tup[1], secondary_tup[1]
        )
        
        # --- LAYOUT DO RELAT√ìRIO ---
        st.success("An√°lise conclu√≠da com sucesso.")
        
        # Se√ß√£o Hero: O Gr√°fico e os √çndices
        col_graph, col_data = st.columns([3, 2])
        
        with col_graph:
            st.subheader("Sua Geometria Comportamental")
            # Chama a fun√ß√£o de plotagem avan√ßada do Plotly
            fig = plot_advanced_radar_chart(scores_pct, primary_tup[0])
            st.plotly_chart(fig, use_container_width=True)
            
        with col_data:
            st.subheader("√çndices de Energia")
            st.write("Como sua energia natural est√° distribu√≠da:")
            
            # Mapeamento de nomes amig√°veis
            names_map = {"D": "Executor (Domin√¢ncia)", "I": "Comunicador (Influ√™ncia)", "S": "Planejador (Estabilidade)", "C": "Analista (Conformidade)"}
            
            # Exibe barras de progresso para cada perfil
            for code, pct in scores_pct.items():
                st.write(f"**{names_map[code]}**: {pct:.1f}%")
                st.progress(int(pct))
            
            st.metric(label="Perfil Predominante", value=names_map[primary_tup[0]])

        st.markdown("---")
        
        # Se√ß√£o de Feedback do Especialista
        st.header("üìã Laudo do Especialista")
        st.subheader(f"Diagn√≥stico: {feedback_data['title']}")
        
        with st.expander("üåü LUZ: Suas Potencialidades Naturais", expanded=True):
            st.markdown(feedback_data["luz"])
            
        with st.expander("üåë SOMBRA: Seus Pontos Cegos e Riscos sob Press√£o", expanded=True):
            st.markdown(feedback_data["sombra"])
            
        with st.expander("üöÄ Plano de A√ß√£o Imediato (Recomenda√ß√£o do Coach)", expanded=True):
            st.markdown(f"üí° **Sua tarefa de desenvolvimento:** {feedback_data['acao']}")
            
        # Bot√£o para refazer (para testes)
        if st.button("Realizar Nova Avalia√ß√£o"):
            st.session_state.submitted = False
            st.rerun()

# Rodap√©
st.markdown("---")
st.caption("Sistema desenvolvido com Python, Streamlit e Plotly. Baseado em modelagem comportamental profissional.")
